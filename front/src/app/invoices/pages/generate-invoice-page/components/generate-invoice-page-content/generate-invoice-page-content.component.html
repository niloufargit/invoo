<div class="w-full flex flex-col gap-4">
  @if(store.invoiceProducts()){
    <div class="flex gap-4 items-center">
      <h2 class="text-lg font-semibold">Selected Products</h2>
    </div>
    <div class="p-2 gap-1 border-b border-b-slate-700 flex items-center">
      <p class="w-1/5 text-center font-semibold">Name</p>
      <p class="w-2/5 text-center font-semibold">Description</p>
      <p class="w-1/5 text-center font-semibold">Price U/HT</p>
      <p class="w-1/5 text-center font-semibold">TVA %</p>
      <p class="w-1/5 text-center font-semibold">Quantity</p>
      <p class="w-1/5 text-center font-semibold">Total HT</p>
      <p class="w-1/5 text-center font-semibold">Total TTC</p>
      <button (click)="openProductsModal()" class="border-slate-800 rounded cursor-pointer hover:bg-slate-100 border p-2 w-min h-min">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 512 512">
          <path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/>
        </svg>
      </button>
    </div>

    @for (product of store.invoiceProducts(); track $index) {
      <div class="bg-white shadow-sm p-2 flex gap-1 items-center">
        <p class="w-1/5 text-center text-base font-medium text-gray-800">{{ product?.name }}</p>
        <p class="w-2/5 text-center text-base font-medium text-gray-800">{{ product?.description }}</p>
        <p class="w-1/5 text-center text-base font-medium text-gray-800">{{ product?.htPrice }}</p>
        <p class="w-1/5 text-center text-base font-medium text-gray-800">{{ product?.vatRate }}%</p>
        <p class="w-1/5 text-center text-base font-medium text-gray-800">{{ product?.quantity }}</p>
        <p class="w-1/5 text-center text-base font-medium text-gray-800">
          {{ ((parseFloat(product?.htPrice ?? '0') * (product?.quantity ?? 0)).toFixed(2)) }}
        </p>
        <p class="w-1/5 text-center text-base font-medium text-gray-800">
          {{ ((parseFloat(product?.htPrice ?? '0') * (product?.quantity ?? 0) * (1 + (parseFloat(product?.vatRate ?? '0')) / 100)).toFixed(2)) }}
        </p>
          <button (click)="this.store.removeInvoiceProduct(product)" class="border-[#ff2929] rounded cursor-pointer hover:bg-red-100 border p-2 w-min h-min">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0,0,256,256"><g fill="#ff2929" fill-rule="nonzero" stroke="none" stroke-width="1" stroke-linecap="butt" stroke-linejoin="miter" stroke-miterlimit="10" stroke-dasharray="" stroke-dashoffset="0" font-family="none" font-size="none" style="mix-blend-mode: normal;"><g transform="scale(5.12,5.12)"><path d="M21,0c-1.64453,0 -3,1.35547 -3,3v2h-7.8125c-0.125,-0.02344 -0.25,-0.02344 -0.375,0h-1.8125c-0.03125,0 -0.0625,0 -0.09375,0c-0.55078,0.02734 -0.98047,0.49609 -0.95312,1.04688c0.02734,0.55078 0.49609,0.98047 1.04688,0.95313h1.09375l3.59375,40.5c0.125,1.39844 1.31641,2.5 2.71875,2.5h19.1875c1.40234,0 2.59375,-1.10156 2.71875,-2.5l3.59375,-40.5h1.09375c0.35938,0.00391 0.69531,-0.18359 0.87891,-0.49609c0.17969,-0.3125 0.17969,-0.69531 0,-1.00781c-0.18359,-0.3125 -0.51953,-0.5 -0.87891,-0.49609h-10v-2c0,-1.64453 -1.35547,-3 -3,-3zM21,2h8c0.5625,0 1,0.4375 1,1v2h-10v-2c0,-0.5625 0.4375,-1 1,-1zM11.09375,7h27.8125l-3.59375,40.34375c-0.03125,0.34766 -0.40234,0.65625 -0.71875,0.65625h-19.1875c-0.31641,0 -0.6875,-0.30859 -0.71875,-0.65625zM18.90625,9.96875c-0.04297,0.00781 -0.08594,0.01953 -0.125,0.03125c-0.46484,0.10547 -0.79297,0.52344 -0.78125,1v33c-0.00391,0.35938 0.18359,0.69531 0.49609,0.87891c0.3125,0.17969 0.69531,0.17969 1.00781,0c0.3125,-0.18359 0.5,-0.51953 0.49609,-0.87891v-33c0.01172,-0.28906 -0.10547,-0.56641 -0.3125,-0.76172c-0.21094,-0.19922 -0.49609,-0.29687 -0.78125,-0.26953zM24.90625,9.96875c-0.04297,0.00781 -0.08594,0.01953 -0.125,0.03125c-0.46484,0.10547 -0.79297,0.52344 -0.78125,1v33c-0.00391,0.35938 0.18359,0.69531 0.49609,0.87891c0.3125,0.17969 0.69531,0.17969 1.00781,0c0.3125,-0.18359 0.5,-0.51953 0.49609,-0.87891v-33c0.01172,-0.28906 -0.10547,-0.56641 -0.3125,-0.76172c-0.21094,-0.19922 -0.49609,-0.29687 -0.78125,-0.26953zM30.90625,9.96875c-0.04297,0.00781 -0.08594,0.01953 -0.125,0.03125c-0.46484,0.10547 -0.79297,0.52344 -0.78125,1v33c-0.00391,0.35938 0.18359,0.69531 0.49609,0.87891c0.3125,0.17969 0.69531,0.17969 1.00781,0c0.3125,-0.18359 0.5,-0.51953 0.49609,-0.87891v-33c0.01172,-0.28906 -0.10547,-0.56641 -0.3125,-0.76172c-0.21094,-0.19922 -0.49609,-0.29687 -0.78125,-0.26953z"></path></g></g></svg>
        </button>
      </div>
    }
    <div class="w-full flex justify-end gap-4 mt-4 border-t border-gray-300 pt-4">
      <div class="text-right">
        <h4 class="text-lg font-semibold">Total HT:</h4>
        <h4 class="text-lg font-semibold">Total TTC:</h4>
      </div>
      <div class="text-right">
        <h4 class="text-lg font-medium text-gray-800">
          {{ store.getTotalHT() }}
        </h4>
        <h4 class="text-lg font-medium text-gray-800">
          {{ store.getTotalTTC() }}
        </h4>
      </div>
    </div>
    <div class="text-center w-full">
      <button (click)="store.generateInvoice()" class="bg-slate-800 whitespace-nowrap text-white text-wrap border-slate-800 rounded cursor-pointer hover:bg-slate-100 hover:text-slate-800 border p-2 w-min h-min">
        Generate Invoice
      </button>
    </div>

  } @else {
    <div class="w-full justify-center items-center flex flex-col gap-4">
      <h2>Select your products</h2>
      <button (click)="openProductsModal()" class=" cursor-pointer rounded-md bg-slate-800 py-2 px-4 border border-transparent text-center text-sm text-white transition-all shadow-md hover:shadow-lg hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none ml-2" type="button">
        Add Products
      </button>
      <p class="text-gray-500 text-sm">No products selected yet.</p>
    </div>
  }
  @if(isProductsModalOpen){
    <app-modal [isOpen]="isProductsModalOpen">
      <div class="w-full h-full flex justify-center items-center">
        <app-card-component class="w-4xl shadow-xl" customClass=" h-[800px] rounded-lg shadow-md p-8 flex-col w-3xl gap-4 overflow-y-scroll">
          <button class="self-end bg-white cursor-pointer w-min " (click)="openProductsModal()">
            <svg xmlns="http://www.w3.org/2000/svg" height="24" width="18" viewBox="0 0 384 512"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/></svg>
          </button>
          <div class="relative flex">
            <input
              class="w-full bg-transparent placeholder:text-slate-400 text-slate-700 text-sm border border-slate-200 rounded-md pl-3 pr-28 py-2 transition duration-300 ease focus:outline-none focus:border-slate-400 hover:border-slate-300 shadow-sm focus:shadow"
              placeholder="Search products..."
              type="text"
              [(ngModel)]="searchTerm"
            />
            <button
              class="cursor-pointer top-1 right-1 flex items-center rounded bg-slate-800 py-1 px-2.5 border border-transparent text-center text-sm text-white transition-all shadow-sm hover:shadow focus:bg-slate-700 focus:shadow-none active:bg-slate-700 hover:bg-slate-700 active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
              type="button"
            >
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-2">
                <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z" clip-rule="evenodd" />
              </svg>
              Search
            </button>
          </div>
          <div class="p-2 border-b border-b-gray-600 flex gap-1 items-center">
            <div class="w-1/5 text-center">
              <p>Quantity</p>
            </div>
            <div class="w-1/5 text-center">
              <p>Name</p>
            </div>
            <div class="w-1/5 text-center">
              <p>Price U/HT</p>
            </div>
            <div class="w-2/5 text-center">
              <p>Description</p>
            </div>
            <div class="w-1/4 text-center">
              <p>TVA %</p>
            </div>
          </div>
          @if(store.products()) {
            @for (product of filteredProducts; track $index) {
              <div class="flex justify-between items-center gap-1 hover:bg-gray-100 p-2 rounded-md cursor-pointer">
                <div class="w-1/5 flex items-center gap-2">
                  <button
                    class="w-6 h-6 flex items-center justify-center border rounded border-gray-300 bg-gray-100 hover:bg-gray-300"
                    (click)="decrementQuantity(product)"
                    type="button"
                  >
                    -
                  </button>
                  <p class="w-6 text-center">{{ store.getProductQuantity(product) ?? 0 }}</p>
                  <button
                    class="w-6 h-6 flex items-center justify-center border rounded border-gray-300 bg-gray-100 hover:bg-gray-300"
                    (click)="incrementQuantity(product)"
                  >
                    +
                  </button>
                </div>
                <div class="w-1/5 text-center">
                  <p>{{ product?.name }}</p>
                </div>
                <div class="w-1/5 text-center">
                  <p>{{ product?.htPrice }}</p>
                </div>
                <div class="w-2/5 text-center">
                  <p>{{ product?.description }}</p>
                </div>
                <div class="w-1/5 text-center">
                  <p>{{ product?.vatRate }}%</p>
                </div>
                <div class="w-6 flex justify-center">
                  @if(store.productIsSelected(product)) {
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-5 h-5">
                      <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"></path>
                    </svg>
                  }
                </div>
              </div>
              <hr class="border-gray-300" />
            }
          }
          @else {
            <p>No products available. Please add a product.</p>
          }
        </app-card-component>
      </div>
    </app-modal>
  }
</div>
